{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-7">
            <h2 class="mb-4 text-center">{{ title }}</h2>
            
            <div class="card shadow-lg p-5 border-0">
                
                {% set form_action = url_for('create_vehicle') %}
                {% set cancel_url = url_for('list_vehicles') %}
                {% if vehicle.id %}
                    {% set form_action = url_for('update_vehicle', vehicle_id=vehicle.id) %}
                {% elif client %}
                    {# Se estamos criando para um cliente específico, voltamos para a página dele #}
                    {% set cancel_url = url_for('show_client', client_id=client.id) %}
                {% endif %}

                {# O action é dinâmico (create ou update) #}
                <form method="POST" action="{{ form_action }}" enctype="multipart/form-data">
                    
                    {# ---------------------------------------------------- #}
                    {# Lógica Condicional para Seleção de Cliente / Exibição #}
                    {# ---------------------------------------------------- #}
                    
                    {% if client %}
                    {# MODO 1: Cliente conhecido (Veículo sendo criado através da página do cliente) #}
                        <input type="hidden" name="client_id" value="{{ client.id }}">
                        <h5 class="card-title mb-4">
                            Cliente: <a href="{{ url_for('show_client', client_id=client.id) }}" class="text-primary fw-bold">{{ client.name }}</a>
                        </h5>

                    {% elif clients %}
                    {# MODO 2: Lista de clientes disponível (Veículo sendo criado pela rota geral) #}
                        <div class="mb-4">
                            <label for="client_id" class="form-label fw-bold">Selecione o Cliente</label>
                            <select class="form-select" id="client_id" name="client_id" required>
                                <option value="" disabled selected>-- Escolha um Cliente --</option>
                                {% for c in clients %}
                                    <option value="{{ c.id }}" 
                                            {% if vehicle and vehicle.client_id == c.id %}selected{% endif %}>
                                        {{ c.name }} (ID: {{ c.id }})
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    
                    {% else %}
                        <div class="alert alert-danger" role="alert">
                            Erro: Nenhum cliente encontrado. Não é possível cadastrar um veículo.
                        </div>
                    {% endif %}
                    
                    {# ---------------------------------------------------- #}
                    {# Campos do Veículo #}
                    {# ---------------------------------------------------- #}

                    <div class="mb-3">
                        <label for="model" class="form-label">Modelo/Marca do Veículo</label>
                        <input type="text" class="form-control" id="model" name="model" value="{{ vehicle.model or '' }}" required>
                    </div>

                    <div class="mb-3">
                        <label for="plate" class="form-label">Placa</label>
                        <input type="text" class="form-control text-uppercase" id="plate" name="plate" value="{{ vehicle.plate or '' }}" required>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="year" class="form-label">Ano</label>
                            <input type="number" class="form-control" id="year" name="year" min="1900" max="2099" value="{{ vehicle.year or '' }}" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="color" class="form-label">Cor</label>
                            <input type="text" class="form-control" id="color" name="color" value="{{ vehicle.color or '' }}">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="observations" class="form-label">Observações (Opcional)</label>
                        <textarea class="form-control" id="observations" name="observations" rows="3">{{ vehicle.observations or '' }}</textarea>
                    </div>

                    <div class="mb-4">
                        <label for="photo" class="form-label">Foto do Veículo (Opcional)</label>
                        <input type="file" class="form-control" id="photo" name="photo" accept="image/*">
                        {% if vehicle and vehicle.image_url %}
                            <small class="form-text text-muted mt-2">Imagem atual: <a href="{{ vehicle.image_url }}" target="_blank">Visualizar</a></small>
                        {% endif %}
                    </div>

                    <button type="submit" class="btn btn-primary btn-lg">
                        {% if vehicle.id %}Salvar Alterações{% else %}Cadastrar Veículo{% endif %}
                    </button>
                        
                        <a href="{{ cancel_url }}" class="btn btn-outline-secondary">Cancelar</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}